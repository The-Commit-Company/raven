{% extends "templates/web.html" %}

{% block page_content %}
<div class="chat-container">
    <!-- Danh sách cuộc trò chuyện -->
    <div class="conversation-list">
        <!-- Danh sách cuộc trò chuyện sẽ được thêm vào đây -->
    </div>

    <!-- Khu vực chat -->
    <div class="chat-area">
        <!-- Danh sách tin nhắn -->
        <div class="chat-messages">
            <!-- Tin nhắn sẽ được thêm vào đây -->
        </div>

        <!-- Khu vực nhập tin nhắn -->
        <div class="message-input">
            <textarea placeholder="Nhập tin nhắn của bạn..."></textarea>
            <button type="button" onclick="send_message(); return false;">Gửi</button>
        </div>
    </div>
</div>

{% endblock %}

{% block style %}
<link rel="stylesheet" href="/assets/raven/chatbot/chat.css">
{% endblock %}

{% block script %}
<script src="/assets/raven/chatbot/chat.js"></script>
<script>
    // Khởi tạo chat khi trang được tải
    $(document).ready(function() {
        console.log("=== CHAT PAGE LOADED ===");
        
        // Lấy danh sách tin nhắn nếu đang trong cuộc trò chuyện
        const conversation_id = frappe.get_route()[2];
        console.log("Conversation ID:", conversation_id);
        
        if (conversation_id) {
            console.log("Đang lấy danh sách tin nhắn...");
            raven.chatbot.get_messages(conversation_id).then(function(r) {
                console.log("Kết quả lấy danh sách tin nhắn:", r);
                if (r.message) {
                    r.message.forEach(function(message) {
                        append_message(message);
                    });
                }
            }).fail(function(err) {
                console.error("Lỗi khi lấy danh sách tin nhắn:", err);
                frappe.show_alert({
                    message: "Có lỗi xảy ra khi lấy danh sách tin nhắn. Vui lòng thử lại.",
                    indicator: "red"
                });
            });
        }
    });

    // Hàm gửi tin nhắn
    function send_message() {
        const conversation_id = frappe.get_route()[2];
        const message = $('.message-input textarea').val().trim();
        
        console.log("=== GỬI TIN NHẮN ===");
        console.log("Conversation ID:", conversation_id);
        console.log("Message:", message);
        
        if (!message) {
            console.warn("Tin nhắn trống");
            frappe.show_alert({
                message: "Vui lòng nhập tin nhắn",
                indicator: "red"
            });
            return;
        }
        
        if (!conversation_id) {
            console.warn("Không có conversation_id");
            frappe.show_alert({
                message: "Vui lòng chọn hoặc tạo cuộc trò chuyện mới",
                indicator: "red"
            });
            return;
        }
        
        console.log("Đang gửi tin nhắn...");
        raven.chatbot.send_message(conversation_id, message).then(function(r) {
            console.log("Kết quả gửi tin nhắn:", r);
            if (r.message) {
                $('.message-input textarea').val('');
            }
        }).fail(function(err) {
            console.error("Lỗi khi gửi tin nhắn:", err);
            frappe.show_alert({
                message: "Có lỗi xảy ra khi gửi tin nhắn. Vui lòng thử lại.",
                indicator: "red"
            });
        });
    }

    // Gửi tin nhắn khi nhấn Enter
    $('.message-input textarea').on('keypress', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            send_message();
        }
    });
</script>
{% endblock %} 